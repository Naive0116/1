<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TastyTrack | æ™ºæ…§é£Ÿå ‚ Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', '"San Francisco"', 'Helvetica', 'Arial', 'sans-serif'] },
                    colors: {
                        ios: { bg: '#F5F5F7', card: '#FFFFFF', blue: '#007AFF', green: '#34C759', red: '#FF3B30', gray: '#8E8E93', text: '#1D1D1F', orange: '#FF9500' }
                    },
                    boxShadow: {
                        'apple': '0 4px 20px rgba(0, 0, 0, 0.04)',
                        'apple-hover': '0 8px 30px rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F5F5F7; -webkit-font-smoothing: antialiased; }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { width: 20px; height: 20px; border: 2px solid #E5E5EA; border-bottom-color: #007AFF; border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .preview-card { opacity: 0.8; border: 1px dashed #d1d5db; }
        .active-day-btn { background-color: #000; color: #fff; }
        .inactive-day-btn { background-color: #f3f4f6; color: #6b7280; }
        
        /* Rank Styles */
        .rank-1 { color: #FF3B30; font-size: 2rem; font-weight: 900; font-style: italic; }
        .rank-2 { color: #FF9500; font-size: 1.8rem; font-weight: 800; font-style: italic; }
        .rank-3 { color: #FFCC00; font-size: 1.6rem; font-weight: 800; font-style: italic; }
        .rank-other { color: #8E8E93; font-size: 1.2rem; font-weight: 600; }
    </style>
</head>
<body class="text-ios-text font-sans min-h-screen pb-24">

    <!-- Loading -->
    <div id="init-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="loader mb-4 w-8 h-8 border-4"></div>
        <p class="text-gray-400 text-sm font-medium">ç³»ç»ŸåŠ è½½ä¸­...</p>
    </div>

    <!-- Nav (Clean) -->
    <nav class="glass-nav sticky top-0 z-50 w-full h-16">
        <div class="max-w-6xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.switchView('home')">
                <div class="bg-black text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm shadow-md"><i class="fa-solid fa-utensils"></i></div>
                <span class="font-semibold text-lg tracking-tight text-black">TastyTrack</span>
            </div>
            <div class="hidden md:flex space-x-1 bg-gray-100/50 p-1 rounded-full backdrop-blur-sm">
                <button onclick="app.switchView('home')" id="nav-home" class="px-5 py-1.5 rounded-full text-sm font-medium transition-all text-gray-500 hover:text-black">ä¸»é¡µ</button>
                <button onclick="app.switchView('stats')" id="nav-stats" class="px-5 py-1.5 rounded-full text-sm font-medium transition-all text-gray-500 hover:text-black">æ¦œå•</button>
                <button onclick="app.checkAdminAccess()" id="nav-admin" class="px-5 py-1.5 rounded-full text-sm font-medium transition-all text-gray-500 hover:text-black">ç®¡ç†</button>
            </div>
            <div class="w-8"></div>
        </div>
    </nav>

    <!-- Mobile Nav -->
    <div class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-black/80 backdrop-blur-xl text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-8">
        <button onclick="app.switchView('home')"><i class="fa-solid fa-house text-xl"></i></button>
        <button onclick="app.switchView('stats')"><i class="fa-solid fa-ranking-star text-xl"></i></button>
        <button onclick="app.checkAdminAccess()"><i class="fa-solid fa-lock text-xl"></i></button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="max-w-6xl mx-auto px-4 pt-8 animate-fade-in">

        <!-- VIEW 1: HOME -->
        <section id="view-home" class="space-y-10">
            <!-- Header -->
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-black">ä»Šæ—¥ä¾›åº”</h1>
                    <p class="text-gray-500 mt-1 flex items-center gap-2">
                        <span id="display-date-today">YYYY-MM-DD</span> 
                        <span id="display-weekday-today" class="bg-gray-100 px-2 py-0.5 rounded text-xs">å‘¨-</span>
                    </p>
                </div>
                <!-- Meal Filter -->
                <div class="bg-white p-1 rounded-full shadow-apple inline-flex">
                    <button onclick="app.filterMeal('breakfast')" id="btn-breakfast" class="px-4 py-1.5 rounded-full text-xs font-medium text-gray-500">æ—©é¤</button>
                    <button onclick="app.filterMeal('lunch')" id="btn-lunch" class="px-4 py-1.5 rounded-full text-xs font-medium bg-black text-white shadow-md">åˆé¤</button>
                    <button onclick="app.filterMeal('dinner')" id="btn-dinner" class="px-4 py-1.5 rounded-full text-xs font-medium text-gray-500">æ™šé¤</button>
                </div>
            </div>

            <!-- Today's Grid -->
            <div id="today-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- JS Injected -->
            </div>

            <div class="border-t border-gray-200 pt-8">
                <h2 class="text-2xl font-bold tracking-tight text-gray-400 flex items-center gap-2 mb-6">
                    <i class="fa-regular fa-calendar-check"></i> æ˜æ—¥é¢„å‘Š
                    <span class="text-sm font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded-lg" id="display-date-tmrw">Loading...</span>
                </h2>
                <div id="tmrw-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 opacity-75 hover:opacity-100 transition-opacity">
                    <!-- JS Injected -->
                </div>
            </div>
        </section>

        <!-- VIEW 2: STATS (Visual Hot List) -->
        <section id="view-stats" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Hot List Column -->
            <div class="lg:col-span-2 space-y-6">
                <div>
                    <h2 class="text-3xl font-bold tracking-tight text-black mb-2">ç¾é£Ÿçƒ­åŠ›æ¦œ</h2>
                    <p class="text-gray-500">ç»¼åˆè¯„åˆ†ä¸äººæ°” Top 10</p>
                </div>
                <div id="hot-list" class="space-y-4">
                    <!-- JS Injected Hot Items -->
                </div>
            </div>

            <!-- Comments Column -->
            <div class="bg-white rounded-3xl p-6 shadow-apple border border-white/50 h-fit sticky top-24">
                <h2 class="text-xl font-bold tracking-tight mb-6 flex items-center gap-2">
                    <span class="bg-ios-blue text-white w-6 h-6 rounded-full flex items-center justify-center text-xs"><i class="fa-solid fa-comment"></i></span>
                    æœ€æ–°é£Ÿå®¢è¯„ä»·
                </h2>
                <div id="live-comments-list" class="space-y-4 max-h-[600px] overflow-y-auto pr-2 no-scrollbar"></div>
            </div>
        </section>

        <!-- VIEW 3: ADMIN -->
        <section id="view-admin" class="hidden">
            <!-- Login -->
            <div id="admin-login-panel" class="max-w-md mx-auto mt-20 bg-white rounded-3xl shadow-2xl p-10 text-center">
                <h2 class="text-2xl font-bold mb-6">ç®¡ç†å‘˜ç™»å½•</h2>
                <form id="login-form" class="space-y-4">
                    <input type="text" id="admin-user" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-black/5" placeholder="è´¦å·">
                    <input type="password" id="admin-pass" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-black/5" placeholder="å¯†ç ">
                    <button type="submit" class="w-full bg-black text-white font-bold rounded-xl py-3 mt-4 hover:scale-[1.02] transition-transform">éªŒè¯èº«ä»½</button>
                </form>
            </div>

            <!-- Dashboard -->
            <div id="admin-dashboard" class="hidden space-y-8">
                <div class="flex justify-between items-center bg-black text-white rounded-3xl p-8 shadow-apple-hover">
                    <div><h2 class="text-3xl font-bold">åå°ç®¡ç†</h2><p class="text-gray-400 text-sm mt-1">æ’æœŸä¸ç»´æŠ¤</p></div>
                    <div class="flex gap-2">
                        <button onclick="app.switchAdminMode('daily')" class="px-4 py-2 bg-white/20 rounded-full text-xs backdrop-blur-md hover:bg-white/30 transition">æ¯æ—¥æ˜ç»†</button>
                        <button onclick="app.switchAdminMode('weekly')" class="px-4 py-2 bg-ios-blue text-white rounded-full text-xs shadow-lg hover:brightness-110 transition">å‘¨å¸¸æ¨¡æ¿</button>
                        <button onclick="app.logout()" class="px-4 py-2 bg-red-500/20 text-red-300 rounded-full text-xs hover:bg-red-500/30 transition">é€€å‡º</button>
                    </div>
                </div>

                <!-- Loader for AI Generation -->
                <div id="ai-loader" class="hidden fixed inset-0 bg-black/50 z-[200] flex flex-col items-center justify-center backdrop-blur-sm">
                    <div class="loader mb-4 w-10 h-10 border-4 border-white border-b-ios-blue"></div>
                    <p class="text-white font-bold text-lg animate-pulse">AI æ­£åœ¨ç»˜åˆ¶ç¾é£Ÿ...</p>
                    <p class="text-white/70 text-sm mt-2">é¢„è®¡ 15-20 ç§’ï¼Œè¯·å‹¿å…³é—­</p>
                </div>

                <!-- MODE A: WEEKLY TEMPLATE -->
                <div id="admin-mode-weekly" class="hidden space-y-6 animate-fade-in">
                    <div class="bg-blue-50 border border-blue-100 p-4 rounded-2xl flex items-start gap-3">
                        <i class="fa-solid fa-circle-info text-blue-500 mt-1"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-bold">å‘¨å¸¸æ¨¡æ¿è®¾ç½®</p>
                            <p>ä¸ºæ¯å‘¨å›ºå®šæ—¥è®¾ç½®èœè°±ã€‚æ–°èœå“å°†è‡ªåŠ¨è§¦å‘ AI ç”Ÿå›¾ã€‚</p>
                        </div>
                    </div>
                    <div class="flex overflow-x-auto gap-2 pb-2 no-scrollbar" id="weekday-selector"></div>
                    
                    <!-- Add Template Form -->
                    <div class="bg-white p-6 rounded-3xl shadow-apple">
                        <h3 class="font-bold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-calendar-week text-ios-blue"></i> 
                            è®¾ç½® <span id="current-template-day-name" class="text-ios-blue">å‘¨ä¸€</span> æ¨¡æ¿
                        </h3>
                        <form id="add-template-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <select id="tpl-meal" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3"><option value="breakfast">æ—©é¤</option><option value="lunch">åˆé¤</option><option value="dinner">æ™šé¤</option></select>
                                <input type="number" id="tpl-price" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="ä»·æ ¼ (Â¥)">
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="tpl-name" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="èœå“åç§° (ä¾‹å¦‚: çº¢çƒ§ç‹®å­å¤´)" required>
                                <button type="submit" class="flex-shrink-0 bg-ios-blue text-white font-bold rounded-xl px-6 py-3 hover:brightness-105 transition-all flex items-center">
                                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ç”Ÿæˆå¹¶æ·»åŠ 
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Template List -->
                    <div class="bg-white rounded-3xl shadow-apple overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-gray-500 text-sm">å½“å‰æ¨¡æ¿èœå“</h3>
                            <button onclick="app.generateNextWeek()" class="bg-black text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:scale-105 transition-transform">åº”ç”¨æ¨¡æ¿åˆ°ä¸‹å‘¨</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-white text-gray-400"><tr><th class="px-6 py-3">å›¾ç‰‡</th><th class="px-6 py-3">èœå</th><th class="px-6 py-3">æ—¶æ®µ</th><th class="px-6 py-3 text-right">æ“ä½œ</th></tr></thead>
                                <tbody id="template-list" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- MODE B: DAILY MANAGEMENT -->
                <div id="admin-mode-daily" class="space-y-6 animate-fade-in">
                    <div class="bg-white p-6 rounded-3xl shadow-apple">
                        <h3 class="font-bold mb-4">æ·»åŠ ç‰¹å®šæ—¥æœŸèœå“ (æ”¯æŒ AI ç”Ÿå›¾)</h3>
                        <form id="add-dish-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-gray-400 uppercase ml-1">æ—¥æœŸ</label><input type="date" id="new-date" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" required></div>
                                <div><label class="text-xs font-bold text-gray-400 uppercase ml-1">æ—¶æ®µ</label><select id="new-meal" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3"><option value="breakfast">æ—©é¤</option><option value="lunch">åˆé¤</option><option value="dinner">æ™šé¤</option></select></div>
                            </div>
                            <div class="flex gap-2">
                                <input type="text" id="new-name" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="èœå“åç§°" required>
                                <button type="submit" class="flex-shrink-0 bg-ios-green text-white font-bold rounded-xl px-6 py-3 hover:brightness-105 transition-all flex items-center">
                                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>å‘å¸ƒ
                                </button>
                            </div>
                            <input type="number" id="new-price" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="ä»·æ ¼ (Â¥)">
                        </form>
                    </div>
                    <div class="bg-white rounded-3xl shadow-apple overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-gray-50"><h3 class="font-bold text-gray-500 text-sm">å†å²èœå“æ˜ç»†</h3></div>
                        <div class="overflow-x-auto max-h-[400px]">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-white text-gray-400"><tr><th class="px-6 py-3">æ—¥æœŸ</th><th class="px-6 py-3">å›¾ç‰‡</th><th class="px-6 py-3">èœå</th><th class="px-6 py-3">æ—¶æ®µ</th><th class="px-6 py-3 text-right">æ“ä½œ</th></tr></thead>
                                <tbody id="admin-list" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Comment Modal -->
    <div id="comment-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 animate-fade-in transform scale-100">
            <h3 class="font-bold text-lg mb-4">è¯„ä»·: <span id="modal-dish-name"></span></h3>
            <input type="hidden" id="modal-dish-id-hidden">
            <textarea id="comment-text" class="w-full bg-gray-50 rounded-xl p-3 text-sm h-32 focus:outline-none focus:ring-2 focus:ring-ios-blue/50" placeholder="å‘³é“å¦‚ä½•ï¼Ÿæœ‰ä»€ä¹ˆå»ºè®®ï¼Ÿ"></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="app.closeCommentModal()" class="flex-1 py-2 text-sm bg-gray-100 rounded-xl font-bold text-gray-500 hover:bg-gray-200">å–æ¶ˆ</button>
                <button onclick="app.submitCommentAction()" class="flex-1 py-2 text-sm bg-black text-white rounded-xl font-bold hover:scale-[1.02] transition-transform">æäº¤è¯„ä»·</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”´ é…ç½®åŒºåŸŸ (ä¿ç•™äº†æ‚¨çš„é…ç½®)
        // ==========================================
        const supabaseUrl = 'https://zjwqbyijjxoalzchtjrz.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpqd3FieWlqanhvYWx6Y2h0anJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNDM0MTksImV4cCI6MjA4MDgxOTQxOX0.FbPI3J9a8AsdvtpiNIeZ0Ia8dMXutFbuTc_T0ymnFhw'; 
        // é˜¿é‡Œäº‘çµç§¯å¹³å° API Key
        const DASHSCOPE_API_KEY = 'sk-3cfe8487bd9042cba0457b40af8d89c1'; 
        // ==========================================

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        const state = { 
            currentView: 'home', currentMeal: 'lunch', isAdmin: false, 
            dishes: [], templates: [], comments: [], dishImages: {},
            todayStr: new Date().toISOString().split('T')[0],
            adminMode: 'daily', currentTemplateDay: 1
        };

        const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

        const app = {
            init: async () => {
                const today = new Date();
                document.getElementById('display-date-today').innerText = state.todayStr;
                document.getElementById('display-weekday-today').innerText = weekdays[today.getDay()];
                const tmrw = new Date(today); tmrw.setDate(tmrw.getDate()+1);
                document.getElementById('display-date-tmrw').innerText = tmrw.toISOString().split('T')[0] + " " + weekdays[tmrw.getDay()];
                document.getElementById('new-date').value = state.todayStr;

                app.renderWeekdaySelector();
                await app.fetchData();
                app.setupRealtime();
                document.getElementById('init-overlay').classList.add('opacity-0', 'pointer-events-none');
            },

            fetchData: async () => {
                const { data: d } = await supabaseClient.from('dishes').select('*').eq('is_template', false).order('serve_date', {ascending: true});
                const { data: t } = await supabaseClient.from('dishes').select('*').eq('is_template', true).order('created_at', {ascending: true});
                const { data: c } = await supabaseClient.from('comments').select('*').order('created_at', {ascending: false}).limit(30);
                const { data: i } = await supabaseClient.from('dish_images').select('*');
                
                state.dishes = d || []; state.templates = t || []; state.comments = c || [];
                if(i) i.forEach(img => state.dishImages[img.dish_name] = img.image_url);
                app.renderAll();
            },

            // --- AI IMAGE GENERATION ---
            getDishImage: async (dishName) => {
                if (state.dishImages[dishName]) return state.dishImages[dishName]; // Check cache

                document.getElementById('ai-loader').classList.remove('hidden');
                try {
                    // 1. è°ƒç”¨é€šä¹‰åƒé—®ç”Ÿå›¾
                    const prompt = `ä¸€é“ç¾å‘³çš„ä¸­å›½èœè‚´ï¼Œåä¸ºâ€œ${dishName}â€ï¼Œä¸“ä¸šç¾é£Ÿæ‘„å½±ï¼Œç‰¹å†™ï¼Œå…‰çº¿è‡ªç„¶ï¼Œä»¤äººå‚æ¶ã€‚`;
                    const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${DASHSCOPE_API_KEY}`,
                            'X-DashScope-Async': 'enable' 
                        },
                        body: JSON.stringify({
                            model: "wanx-v1",
                            input: { prompt: prompt },
                            parameters: { size: "1024*1024", n: 1 }
                        })
                    });
                    const initialData = await response.json();
                    if(!initialData.output) throw new Error(initialData.message || "API Error");
                    const taskId = initialData.output.task_id;

                    // 2. è½®è¯¢ç»“æœ
                    let imageUrl = null;
                    for(let i=0; i<15; i++) { 
                        await new Promise(r => setTimeout(r, 2000));
                        const taskResp = await fetch(`https://dashscope.aliyuncs.com/api/v1/tasks/${taskId}`, {
                            headers: { 'Authorization': `Bearer ${DASHSCOPE_API_KEY}` }
                        });
                        const taskData = await taskResp.json();
                        if (taskData.output.task_status === 'SUCCEEDED') {
                            imageUrl = taskData.output.results[0].url;
                            break;
                        }
                    }
                    if (!imageUrl) throw new Error("AI ç”Ÿæˆè¶…æ—¶");

                    // 3. è½¬å­˜åˆ° Supabase (è§£å†³å¤–é“¾è¿‡æœŸé—®é¢˜)
                    // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ fetch blobï¼Œå¯èƒ½ä¼šæœ‰ CORSã€‚å¦‚æœå¤±è´¥åˆ™ä½¿ç”¨åŸå§‹é“¾æ¥ã€‚
                    try {
                        const imgBlob = await fetch(imageUrl).then(r => r.blob());
                        const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.png`;
                        const { error: uploadError } = await supabaseClient.storage.from('dish-images').upload(fileName, imgBlob);
                        if(uploadError) throw uploadError;
                        
                        const { data: { publicUrl } } = supabaseClient.storage.from('dish-images').getPublicUrl(fileName);
                        imageUrl = publicUrl; 
                    } catch (uploadErr) {
                        console.warn("è½¬å­˜å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹é“¾æ¥:", uploadErr);
                    }

                    // 4. å­˜å…¥æ•°æ®åº“ç¼“å­˜
                    await supabaseClient.from('dish_images').insert([{ dish_name: dishName, image_url: imageUrl }]);
                    state.dishImages[dishName] = imageUrl;
                    return imageUrl;

                } catch (e) {
                    console.error("AI Error:", e);
                    alert("AI ç”Ÿå›¾é‡åˆ°é—®é¢˜ (å¯èƒ½æ˜¯API Keyé¢åº¦ä¸è¶³æˆ–ç½‘ç»œé—®é¢˜)ï¼Œå°†ä½¿ç”¨é»˜è®¤å›¾ã€‚");
                    return null;
                } finally {
                    document.getElementById('ai-loader').classList.add('hidden');
                }
            },

            // --- ADMIN ACTIONS ---
            addDishGeneric: async (isTemplate, dateStr, weekDay) => {
                const nameInput = isTemplate ? 'tpl-name' : 'new-name';
                const mealInput = isTemplate ? 'tpl-meal' : 'new-meal';
                const priceInput = isTemplate ? 'tpl-price' : 'new-price';
                const formId = isTemplate ? 'add-template-form' : 'add-dish-form';

                const name = document.getElementById(nameInput).value.trim();
                if(!name) return alert("è¯·è¾“å…¥èœå“åç§°");

                // Get AI Image
                const imageUrl = await app.getDishImage(name);

                const newDish = {
                    name: name,
                    meal: document.getElementById(mealInput).value,
                    price: document.getElementById(priceInput).value || 0,
                    serve_date: dateStr, week_day: weekDay, is_template: isTemplate,
                    votes: 0, score: 0, image_url: imageUrl
                };
                const { error } = await supabaseClient.from('dishes').insert([newDish]);
                if(!error) { alert('å‘å¸ƒæˆåŠŸ'); document.getElementById(formId).reset(); }
                else alert('å‘å¸ƒå¤±è´¥: ' + error.message);
            },

            addDish: (e) => { e.preventDefault(); app.addDishGeneric(false, document.getElementById('new-date').value, null); },
            addTemplateDish: (e) => { e.preventDefault(); app.addDishGeneric(true, null, state.currentTemplateDay); },

            generateNextWeek: async () => {
                if(!confirm(`ç¡®å®šè¦å°†æ‰€æœ‰æ¨¡æ¿åº”ç”¨åˆ°ä¸‹å‘¨å—ï¼Ÿ`)) return;
                const nextWeekStart = new Date();
                nextWeekStart.setDate(nextWeekStart.getDate() + (1 + 7 - nextWeekStart.getDay()) % 7);
                const inserts = [];
                for (let i = 0; i < 7; i++) {
                    const targetDate = new Date(nextWeekStart); targetDate.setDate(nextWeekStart.getDate() + i);
                    const dayOfWeek = targetDate.getDay();
                    state.templates.filter(t => t.week_day === dayOfWeek).forEach(t => {
                        inserts.push({
                            name: t.name, meal: t.meal, price: t.price,
                            serve_date: targetDate.toISOString().split('T')[0], is_template: false,
                            votes: 0, score: 0, image_url: t.image_url 
                        });
                    });
                }
                if(inserts.length === 0) return alert("æ— æ¨¡æ¿æ•°æ®");
                const { error } = await supabaseClient.from('dishes').insert(inserts);
                if(!error) { alert(`å·²ç”Ÿæˆä¸‹å‘¨èœå•`); app.switchAdminMode('daily'); }
            },

            deleteDish: async (id) => { if(confirm('ç¡®å®šåˆ é™¤?')) await supabaseClient.from('dishes').delete().eq('id', id); },

            // --- USER INTERACTIONS ---
            submitVote: async (id, star) => {
                const d = state.dishes.find(x => x.id === id);
                if(!d) return;
                await supabaseClient.from('dishes').update({ votes: (d.votes||0)+1, score: (d.score||0)+star }).eq('id', id);
                alert("ğŸ‰ æ„Ÿè°¢æ‚¨çš„è¯„åˆ†ï¼\næˆ‘ä»¬ä¼šç»§ç»­åŠªåŠ›ã€‚");
            },
            openCommentModal: (id, name) => {
                document.getElementById('modal-dish-id-hidden').value = id;
                document.getElementById('modal-dish-name').innerText = name;
                document.getElementById('comment-modal').classList.remove('hidden');
            },
            closeCommentModal: () => {
                document.getElementById('comment-modal').classList.add('hidden');
                document.getElementById('comment-text').value = '';
            },
            submitCommentAction: async () => {
                const text = document.getElementById('comment-text').value.trim();
                const dishId = document.getElementById('modal-dish-id-hidden').value;
                const dish = state.dishes.find(d => d.id == dishId); 
                if(!text || !dishId || !dish) return;
                
                const { error } = await supabaseClient.from('comments').insert([{
                    dish_id: dishId, dish_name: dish.name, text: text, created_at: new Date().toISOString()
                }]);
                if(!error) { alert('è¯„ä»·å·²æäº¤ï¼Œæ„Ÿè°¢æ‚¨çš„åé¦ˆï¼'); app.closeCommentModal(); }
                else alert('è¯„è®ºå¤±è´¥');
            },

            // --- RENDER & HELPERS ---
            checkAdminAccess: () => app.switchView('admin'),
            
            // FIX: Login Logic - Changed .addClass to .classList.add
            login: (e) => { 
                e.preventDefault(); 
                if(document.getElementById('admin-user').value==='gly123' && document.getElementById('admin-pass').value==='123456'){
                    state.isAdmin=true;
                    document.getElementById('admin-login-panel').classList.add('hidden'); // FIXED
                    document.getElementById('admin-dashboard').classList.remove('hidden'); // FIXED
                } else {
                    alert("è´¦å·æˆ–å¯†ç é”™è¯¯ (gly123 / 123456)");
                }
            },
            logout: () => location.reload(),
            switchAdminMode: (mode) => { state.adminMode = mode; document.getElementById('admin-mode-daily').classList.toggle('hidden', mode!=='daily'); document.getElementById('admin-mode-weekly').classList.toggle('hidden', mode!=='weekly'); },
            switchView: (v) => { state.currentView=v; ['home','stats','admin'].forEach(id=>{document.getElementById('nav-'+id).classList.toggle('bg-black',id===v);document.getElementById('nav-'+id).classList.toggle('text-white',id===v);}); ['view-home','view-stats','view-admin'].forEach(el=>document.getElementById(el).classList.add('hidden')); document.getElementById('view-'+v).classList.remove('hidden'); if(v==='stats') app.renderAll(); },
            filterMeal: (m) => { state.currentMeal=m; ['breakfast','lunch','dinner'].forEach(id=>{const btn=document.getElementById('btn-'+id);btn.classList.toggle('bg-black',id===m);btn.classList.toggle('text-white',id===m);btn.classList.toggle('text-gray-500',id!==m);}); app.renderAll(); },
            setTemplateDay: (idx) => { state.currentTemplateDay=idx; app.renderWeekdaySelector(); app.renderAll(); },
            renderWeekdaySelector: () => { document.getElementById('weekday-selector').innerHTML=weekdays.map((day,idx)=>`<button onclick="app.setTemplateDay(${idx})" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all ${idx===state.currentTemplateDay?'active-day-btn shadow-md':'inactive-day-btn'}">${day}</button>`).join(''); document.getElementById('current-template-day-name').innerText=weekdays[state.currentTemplateDay]; },
            setupRealtime: () => { supabaseClient.channel('db').on('postgres_changes',{event:'*',schema:'public',table:'dishes'},app.fetchData).on('postgres_changes',{event:'*',schema:'public',table:'comments'},app.fetchData).on('postgres_changes',{event:'*',schema:'public',table:'dish_images'},app.fetchData).subscribe(); },

            renderAll: () => {
                // Home Grid
                const todayDishes = state.dishes.filter(d => d.serve_date === state.todayStr && d.meal === state.currentMeal);
                app.renderGrid('today-grid', todayDishes, false);
                const tmrw = new Date(); tmrw.setDate(tmrw.getDate()+1); const tmrwStr = tmrw.toISOString().split('T')[0];
                const tmrwDishes = state.dishes.filter(d => d.serve_date === tmrwStr && d.meal === state.currentMeal);
                app.renderGrid('tmrw-grid', tmrwDishes, true);

                // Stats View (Hot List & Comments)
                if(state.currentView === 'stats') {
                    // NEW: Hot List Logic
                    const sorted = [...state.dishes].sort((a,b) => {
                        const scoreA = (a.votes||0) * 0.4 + (a.votes>0?a.score/a.votes:0) * 0.6 * 10;
                        const scoreB = (b.votes||0) * 0.4 + (b.votes>0?b.score/b.votes:0) * 0.6 * 10;
                        return scoreB - scoreA; 
                    }).slice(0, 10);

                    document.getElementById('hot-list').innerHTML = sorted.map((d, i) => {
                        const avg = d.votes>0?(d.score/d.votes).toFixed(1):'0.0';
                        const rankClass = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-other';
                        return `
                        <div class="bg-white rounded-2xl p-4 flex items-center gap-4 shadow-sm border border-gray-100 transform transition-all hover:scale-[1.02]">
                            <div class="${rankClass} w-10 text-center font-sans italic">#${i+1}</div>
                            <img src="${d.image_url || 'https://via.placeholder.com/100?text=Food'}" class="w-16 h-16 rounded-xl object-cover bg-gray-100 shadow-inner">
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg text-gray-900">${d.name}</h3>
                                <div class="flex items-center gap-3 text-sm mt-1">
                                    <span class="flex items-center text-yellow-500 font-bold"><i class="fa-solid fa-star mr-1"></i> ${avg}</span>
                                    <span class="text-gray-400">|</span>
                                    <span class="text-gray-500">${d.votes} äººå·²å°è¿‡</span>
                                </div>
                                <!-- Heat Bar -->
                                <div class="w-full bg-gray-100 rounded-full h-1.5 mt-2 overflow-hidden">
                                    <div class="bg-red-500 h-1.5 rounded-full" style="width: ${Math.min(d.votes, 100)}%"></div>
                                </div>
                            </div>
                        </div>`;
                    }).join('') || '<div class="text-center py-10 text-gray-400">æš‚æ— æ•°æ®ï¼Œå¿«å»å“å°æ‰“åˆ†å§ï¼</div>';

                    document.getElementById('live-comments-list').innerHTML = state.comments.map(c => `
                        <div class="bg-gray-50 p-4 rounded-2xl text-sm border border-gray-100 mb-3">
                            <div class="flex justify-between mb-2">
                                <span class="font-bold text-gray-800 bg-white px-2 py-0.5 rounded shadow-sm">${c.dish_name||'èœå“'}</span>
                                <span class="text-xs text-gray-400">${new Date(c.created_at).toLocaleTimeString().slice(0,5)}</span>
                            </div>
                            <p class="text-gray-600 leading-relaxed">${c.text}</p>
                        </div>
                    `).join('');
                }

                // Admin Lists
                const adminListHtml = (list, isTpl) => list.map(d => `
                    <tr class="hover:bg-gray-50">
                        ${!isTpl?`<td class="px-6 py-3 font-mono text-xs text-gray-500">${d.serve_date}</td>`:''}
                        <td class="px-6 py-2"><img src="${d.image_url || ''}" class="w-10 h-10 rounded-lg bg-gray-100 object-cover border border-gray-200" onerror="this.style.display='none'"></td>
                        <td class="px-6 py-3 font-bold text-gray-800">${d.name}</td>
                        <td class="px-6 py-3 text-xs capitalize text-gray-500">${d.meal}</td>
                        <td class="px-6 py-3 text-right"><button onclick="app.deleteDish(${d.id})" class="text-red-500 hover:text-red-700 font-bold text-xs bg-red-50 px-3 py-1 rounded-lg">åˆ é™¤</button></td>
                    </tr>`).join('');
                document.getElementById('admin-list').innerHTML = adminListHtml(state.dishes, false);
                document.getElementById('template-list').innerHTML = adminListHtml(state.templates.filter(t=>t.week_day===state.currentTemplateDay), true);
            },

            renderGrid: (elId, list, isPreview) => {
                const el = document.getElementById(elId);
                if(list.length===0) return el.innerHTML = `<div class="col-span-full py-10 text-center text-gray-400 text-sm">æš‚æ— å®‰æ’</div>`;
                el.innerHTML = list.map(d => {
                    const avg = d.votes>0?(d.score/d.votes).toFixed(1):'0.0';
                    const cls = isPreview?'preview-card grayscale':'shadow-apple hover:-translate-y-1 transition-transform';
                    return `
                    <div class="bg-white rounded-3xl p-4 ${cls} border border-white/60 relative group">
                        <div class="h-40 w-full rounded-2xl bg-gray-100 mb-4 relative overflow-hidden group">
                            <img src="${d.image_url || ''}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onerror="this.src='https://via.placeholder.com/300x200?text=TastyTrack';this.classList.add('opacity-50');">
                            <div class="absolute top-2 right-2 bg-white/90 backdrop-blur-md px-2 py-1 rounded-lg text-xs font-bold shadow-sm">Â¥${d.price}</div>
                        </div>
                        <div class="flex justify-between items-start mb-2"><h3 class="font-bold text-lg text-gray-900 leading-tight">${d.name}</h3><div class="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded-lg"><i class="fa-solid fa-star text-yellow-400 text-xs"></i><span class="font-bold text-sm text-yellow-700">${avg}</span></div></div>
                        <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                            <div class="flex gap-1">${!isPreview?[1,2,3,4,5].map(s=>`<button onclick="app.submitVote(${d.id},${s})" class="w-8 h-8 rounded-full bg-gray-50 hover:bg-yellow-400 hover:text-white transition-colors text-gray-300 flex items-center justify-center"><i class="fa-solid fa-star text-xs"></i></button>`).join(''):'<span class="text-xs text-gray-400">æ˜æ—¥å¼€å¯</span>'}</div>
                            <button onclick="app.openCommentModal(${d.id}, '${d.name}')" class="text-gray-400 hover:text-ios-blue transition-colors"><i class="fa-regular fa-comment-dots text-xl"></i></button>
                        </div>
                    </div>`;
                }).join('');
            }
        };

        document.getElementById('login-form').addEventListener('submit', app.login);
        document.getElementById('add-dish-form').addEventListener('submit', app.addDish);
        document.getElementById('add-template-form').addEventListener('submit', app.addTemplateDish);
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
