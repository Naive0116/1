<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ™ºæ…§é£Ÿå ‚ Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"PingFang SC"', '"Microsoft YaHei"', 'sans-serif'],
                    },
                    colors: {
                        apple: {
                            bg: '#F5F5F7', card: '#FFFFFF', text: '#1D1D1F', gray: '#86868B', blue: '#0071E3', red: '#FF3B30', green: '#34C759'
                        }
                    },
                    borderRadius: { '4xl': '32px' },
                    boxShadow: { 'soft': '0 4px 24px rgba(0,0,0,0.04)', 'hover': '0 12px 32px rgba(0,0,0,0.08)' }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F5F5F7; color: #1D1D1F; -webkit-font-smoothing: antialiased; }
        .nav-glass { background: rgba(255,255,255,0.72); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .btn-bounce { transition: transform 0.1s; } .btn-bounce:active { transform: scale(0.96); }
        .card-hover { transition: all 0.4s; } .card-hover:hover { transform: translateY(-4px); box-shadow: 0 12px 32px rgba(0,0,0,0.08); }
        .apple-loader { width: 24px; height: 24px; border: 3px solid rgba(0,0,0,0.1); border-top-color: #1D1D1F; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .meal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    </style>
</head>
<body class="font-sans selection:bg-apple-blue selection:text-white pb-32">

    <!-- Loading -->
    <div id="init-overlay" class="fixed inset-0 bg-[#F5F5F7] z-[100] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="apple-loader mb-6"></div>
        <p class="text-apple-gray text-sm font-medium">ç³»ç»ŸåŠ è½½ä¸­...</p>
    </div>

    <!-- Nav -->
    <nav class="nav-glass sticky top-0 z-50 w-full h-[52px]">
        <div class="max-w-[980px] mx-auto px-4 h-full flex justify-between items-center text-xs">
            <div class="flex items-center gap-4 cursor-pointer" onclick="app.switchView('home')">
                <i class="fa-solid fa-utensils text-xl text-apple-orange text-[#FF9500]"></i> 
                <span class="font-semibold ml-1 text-base tracking-tight text-black">æ™ºæ…§é£Ÿå ‚</span>
            </div>
            <div class="hidden md:flex space-x-8 items-center text-[#1D1D1F] opacity-80">
                <button onclick="app.switchView('home')" id="nav-home" class="hover:text-apple-blue transition-all">ä»Šæ—¥ä¾›åº”</button>
                <button onclick="app.switchView('stats')" id="nav-stats" class="hover:text-apple-blue transition-all">è¶‹åŠ¿æ¦œå•</button>
                <button onclick="app.checkAdminAccess()" id="nav-admin" class="hover:text-apple-blue transition-all">ç®¡ç†åå°</button>
            </div>
            <!-- Config button removed as requested -->
            <div class="md:hidden"></div>
        </div>
    </nav>

    <!-- Mobile Tab Bar -->
    <div class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-white/90 backdrop-blur-xl border border-white/20 px-1 py-1 rounded-full shadow-lg flex items-center gap-1 scale-100">
        <button onclick="app.switchView('home')" id="mob-home" class="w-12 h-12 rounded-full flex items-center justify-center text-xl text-black bg-gray-100"><i class="fa-solid fa-utensils"></i></button>
        <button onclick="app.switchView('stats')" id="mob-stats" class="w-12 h-12 rounded-full flex items-center justify-center text-xl text-gray-400"><i class="fa-solid fa-chart-simple"></i></button>
        <button onclick="app.checkAdminAccess()" id="mob-admin" class="w-12 h-12 rounded-full flex items-center justify-center text-xl text-gray-400"><i class="fa-solid fa-gear"></i></button>
    </div>

    <!-- MAIN CONTAINER -->
    <main class="max-w-[980px] mx-auto px-5 pt-12 animate-fade-in">

        <!-- VIEW 1: HOME -->
        <section id="view-home" class="space-y-16">
            <div class="pb-2 border-b border-[#d2d2d7]/50">
                <h1 class="text-4xl md:text-5xl font-semibold tracking-tight text-black mb-2">ä»Šæ—¥èœå•</h1>
                <p class="text-apple-gray text-lg font-medium flex items-center gap-2">
                    <span id="display-date-today">...</span> 
                    <span class="w-1 h-1 bg-apple-gray rounded-full"></span>
                    <span id="display-weekday-today">...</span>
                </p>
            </div>

            <div><h2 class="meal-title text-[#FF9500]"><i class="fa-regular fa-sun"></i> æ—©é¤ Breakfast</h2><div id="grid-breakfast" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div><h2 class="meal-title text-black"><i class="fa-solid fa-bowl-food"></i> åˆé¤ Lunch</h2><div id="grid-lunch" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
            <div><h2 class="meal-title text-[#1D1D1F] opacity-80"><i class="fa-solid fa-moon"></i> æ™šé¤ Dinner</h2><div id="grid-dinner" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>

            <div class="pt-8 border-t border-dashed border-gray-200">
                <div class="flex items-center gap-3 mb-6 opacity-60"><h2 class="text-2xl font-semibold">æ˜æ—¥é¢„å‘Š</h2><span class="text-sm font-medium text-apple-gray bg-white px-2 py-1 rounded-md border" id="display-date-tmrw">Preview</span></div>
                <div id="tmrw-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 opacity-60 grayscale hover:grayscale-0 hover:opacity-100 transition-all duration-500"></div>
            </div>
        </section>

        <!-- VIEW 2: STATS -->
        <section id="view-stats" class="hidden space-y-10">
            <div class="text-center mb-8">
                <h2 class="text-4xl font-semibold tracking-tight mb-2">ç¾é£Ÿçƒ­åŠ›æ¦œ</h2>
                <p class="text-apple-gray text-lg">å¤§å®¶éƒ½åœ¨è°ˆè®ºçš„ç¾å‘³ Top 10</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-6"><div id="hot-list" class="space-y-4"></div></div>
                <div class="bg-white rounded-4xl p-8 shadow-soft border border-white/50 h-fit sticky top-24">
                    <div class="flex items-center justify-between mb-6"><h3 class="text-xl font-semibold">æœ€æ–°è¯„ä»·</h3><span class="text-xs font-bold text-apple-blue bg-blue-50 px-2 py-1 rounded-md">å®æ—¶</span></div>
                    <div id="live-comments-list" class="space-y-6 max-h-[600px] overflow-y-auto pr-2 no-scrollbar"></div>
                </div>
            </div>
        </section>

        <!-- VIEW 3: ADMIN -->
        <section id="view-admin" class="hidden">
            <!-- Login -->
            <div id="admin-login-panel" class="max-w-[360px] mx-auto mt-24 text-center">
                <div class="w-20 h-20 bg-[#E8E8ED] rounded-full mx-auto mb-6 flex items-center justify-center text-3xl text-gray-400"><i class="fa-solid fa-lock"></i></div>
                <h2 class="text-2xl font-semibold mb-2">ç®¡ç†å‘˜ç™»å½•</h2>
                <p class="text-apple-gray text-sm mb-8">è¯·è¾“å…¥å‡­è¯è¿›å…¥åå°</p>
                <form id="login-form" class="space-y-4">
                    <input type="text" id="admin-user" class="w-full bg-white border border-[#D2D2D7] rounded-xl px-4 py-3 text-[15px] focus:outline-none focus:ring-1 focus:ring-apple-blue" placeholder="è´¦å· (gly123)">
                    <input type="password" id="admin-pass" class="w-full bg-white border border-[#D2D2D7] rounded-xl px-4 py-3 text-[15px] focus:outline-none focus:ring-1 focus:ring-apple-blue" placeholder="å¯†ç  (123456)">
                    <button type="submit" class="w-full bg-apple-blue text-white font-medium rounded-xl py-3 mt-2 hover:bg-[#0077ED] btn-bounce shadow-md">ç™» å½•</button>
                </form>
            </div>

            <!-- Dashboard -->
            <div id="admin-dashboard" class="hidden space-y-8">
                <div class="bg-white rounded-4xl p-8 shadow-soft flex flex-col md:flex-row justify-between items-center gap-4">
                    <div><h2 class="text-3xl font-semibold text-black">ç®¡ç†åå°</h2><p class="text-apple-gray mt-1 text-sm">æ’æœŸä¸èœå“ç»´æŠ¤</p></div>
                    <div class="bg-[#F5F5F7] p-1 rounded-full flex">
                        <button onclick="app.switchAdminMode('daily')" id="adm-daily-btn" class="px-5 py-2 bg-white rounded-full shadow-sm text-xs font-semibold text-black">æ¯æ—¥æ˜ç»†</button>
                        <button onclick="app.switchAdminMode('weekly')" id="adm-weekly-btn" class="px-5 py-2 text-apple-gray rounded-full text-xs font-semibold hover:text-black">å‘¨å¸¸æ¨¡æ¿</button>
                    </div>
                    <button onclick="app.logout()" class="text-apple-red text-sm font-medium hover:underline">é€€å‡ºç™»å½•</button>
                </div>

                <!-- AI Loader -->
                <div id="ai-loader" class="hidden fixed inset-0 bg-white/80 backdrop-blur-md z-[200] flex flex-col items-center justify-center">
                    <div class="apple-loader mb-4"></div>
                    <p class="text-black font-semibold text-lg">AI æ­£åœ¨ç»˜åˆ¶...</p>
                    <p class="text-apple-gray text-sm mt-2">ç¾å‘³å³å°†å‘ˆç°ï¼Œè¯·ç¨å€™</p>
                </div>

                <!-- MODE A: WEEKLY -->
                <div id="admin-mode-weekly" class="hidden space-y-6">
                    <div class="flex overflow-x-auto gap-3 pb-2 no-scrollbar" id="weekday-selector"></div>
                    <div class="bg-white p-8 rounded-4xl shadow-soft">
                        <h3 class="text-xl font-semibold mb-6 flex items-center gap-2"><span class="w-2 h-6 bg-apple-blue rounded-full"></span> è®¾ç½® <span id="current-template-day-name" class="text-apple-blue">å‘¨ä¸€</span> æ¨¡æ¿</h3>
                        <form id="add-template-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <select id="tpl-meal" class="w-full bg-[#F5F5F7] border-0 rounded-xl px-4 py-3 text-sm"><option value="breakfast">æ—©é¤</option><option value="lunch">åˆé¤</option><option value="dinner">æ™šé¤</option></select>
                                <input type="number" id="tpl-price" class="w-full bg-[#F5F5F7] border-0 rounded-xl px-4 py-3 text-sm" placeholder="ä»·æ ¼ (Â¥)">
                            </div>
                            <div class="flex gap-3">
                                <input type="text" id="tpl-name" class="w-full bg-[#F5F5F7] border-0 rounded-xl px-4 py-3 text-sm" placeholder="èœå“åç§° (è‡ªåŠ¨ç”Ÿæˆå›¾ç‰‡)" required>
                                <button type="submit" class="flex-shrink-0 bg-black text-white font-medium rounded-xl px-6 py-3 btn-bounce">æ·»åŠ  <i class="fa-solid fa-plus ml-1"></i></button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-white rounded-4xl shadow-soft overflow-hidden">
                        <div class="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50"><h3 class="font-semibold text-sm">æ¨¡æ¿åˆ—è¡¨</h3><button onclick="app.generateNextWeek()" class="text-apple-blue text-xs font-bold hover:underline">åº”ç”¨åˆ°ä¸‹å‘¨</button></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left"><tbody id="template-list" class="divide-y divide-gray-100"></tbody></table></div>
                    </div>
                </div>

                <!-- MODE B: DAILY -->
                <div id="admin-mode-daily" class="space-y-6">
                    <div class="bg-white p-8 rounded-4xl shadow-soft">
                        <h3 class="text-xl font-semibold mb-6">æ·»åŠ å•æ—¥èœå“</h3>
                        <form id="add-dish-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="date" id="new-date" class="w-full bg-[#F5F5F7] border-0 rounded-xl px-4 py-3 text-sm" required>
                                <select id="new-meal" class="w-full bg-[#F5F5F7] border-0 rounded-xl px-4 py-3 text-sm"><option value="breakfast">æ—©é¤</option><option value="lunch">åˆé¤</option><option value="dinner">æ™šé¤</option></select>
                            </div>
                            <div class="flex gap-3">
                                <input type="text" id="new-name" class="w-full bg-[#F5F5F7] border-0 rounded-xl px-4 py-3 text-sm" placeholder="èœå“åç§° (å¦‚: çº¢çƒ§è‚‰)" required>
                                <button type="submit" class="flex-shrink-0 bg-apple-green text-white font-medium rounded-xl px-6 py-3 btn-bounce shadow-md">å‘å¸ƒ</button>
                            </div>
                            <input type="number" id="new-price" class="w-full bg-[#F5F5F7] border-0 rounded-xl px-4 py-3 text-sm" placeholder="ä»·æ ¼ (Â¥)">
                        </form>
                    </div>
                    <div class="bg-white rounded-4xl shadow-soft overflow-hidden">
                        <div class="overflow-x-auto max-h-[500px]">
                            <table class="w-full text-sm text-left"><thead class="bg-gray-50/50 text-apple-gray font-medium"><tr><th class="px-6 py-4">æ—¥æœŸ</th><th class="px-6 py-4">å›¾ç‰‡</th><th class="px-6 py-4">èœå</th><th class="px-6 py-4">æ—¶æ®µ</th><th class="px-6 py-4 text-right">æ“ä½œ</th></tr></thead><tbody id="admin-list" class="divide-y divide-gray-100"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Comment Modal -->
    <div id="comment-modal" class="fixed inset-0 bg-black/20 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4 transition-all duration-300">
        <div class="bg-white rounded-[32px] shadow-2xl w-full max-w-[360px] p-8 transform scale-100 animate-fade-in-up">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gray-50 rounded-full mx-auto mb-4 flex items-center justify-center text-2xl shadow-inner">âœï¸</div>
                <h3 class="text-xl font-semibold">æ’°å†™è¯„ä»·</h3>
                <p class="text-apple-gray text-sm mt-1" id="modal-dish-name">èœå</p>
                <input type="hidden" id="modal-dish-id-hidden">
            </div>
            <textarea id="comment-text" class="w-full bg-[#F5F5F7] rounded-2xl p-4 text-sm h-32 focus:outline-none focus:ring-2 focus:ring-apple-blue/20 resize-none" placeholder="å‘³é“æ€ä¹ˆæ ·ï¼Ÿå†™ç‚¹ä»€ä¹ˆå§..."></textarea>
            <div class="flex gap-3 mt-6">
                <button onclick="app.closeCommentModal()" class="flex-1 py-3 text-sm bg-[#F5F5F7] rounded-xl font-semibold text-gray-500 hover:bg-gray-200 btn-bounce">å–æ¶ˆ</button>
                <button onclick="app.submitCommentAction()" class="flex-1 py-3 text-sm bg-black text-white rounded-xl font-semibold hover:opacity-90 btn-bounce">æäº¤</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-xl border border-gray-200 shadow-hover px-6 py-3 rounded-full flex items-center gap-3 z-[300] transform -translate-y-24 transition-all duration-500">
        <i id="toast-icon" class="fa-solid fa-circle-check text-apple-green text-xl"></i>
        <span class="text-sm font-semibold" id="toast-msg">æ“ä½œæˆåŠŸ</span>
    </div>

    <script>
        // ==========================================
        // ğŸš€ é…ç½®åŒºåŸŸ
        // ==========================================
        const supabaseUrl = 'https://zjwqbyijjxoalzchtjrz.supabase.co'; 
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpqd3FieWlqanhvYWx6Y2h0anJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNDM0MTksImV4cCI6MjA4MDgxOTQxOX0.FbPI3J9a8AsdvtpiNIeZ0Ia8dMXutFbuTc_T0ymnFhw'; 
        const DASHSCOPE_API_KEY = 'sk-3cfe8487bd9042cba0457b40af8d89c1'; 
        // ==========================================

        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        const state = { 
            currentView: 'home', isAdmin: false, 
            dishes: [], templates: [], comments: [], dishImages: {},
            todayStr: new Date().toISOString().split('T')[0],
            adminMode: 'daily', currentTemplateDay: 1
        };

        const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

        const app = {
            init: async () => {
                const today = new Date();
                document.getElementById('display-date-today').innerText = today.toLocaleDateString('zh-CN', { month: 'long', day: 'numeric' });
                document.getElementById('display-weekday-today').innerText = weekdays[today.getDay()];
                document.getElementById('new-date').value = state.todayStr;

                app.renderWeekdaySelector();
                await app.fetchData();
                app.setupRealtime();
                document.getElementById('init-overlay').classList.add('opacity-0', 'pointer-events-none');
            },

            fetchData: async () => {
                const { data: d } = await supabaseClient.from('dishes').select('*').eq('is_template', false).order('serve_date', {ascending: true});
                const { data: t } = await supabaseClient.from('dishes').select('*').eq('is_template', true).order('created_at', {ascending: true});
                const { data: c } = await supabaseClient.from('comments').select('*').order('created_at', {ascending: false}).limit(30);
                const { data: i } = await supabaseClient.from('dish_images').select('*');
                
                state.dishes = d || []; state.templates = t || []; state.comments = c || [];
                if(i) i.forEach(img => state.dishImages[img.dish_name] = img.image_url);
                app.renderAll();
            },

            // --- AI IMAGE GENERATION (Optimized) ---
            getDishImage: async (dishName) => {
                if (state.dishImages[dishName]) return state.dishImages[dishName]; 
                
                // Show loader
                document.getElementById('ai-loader').classList.remove('hidden');
                
                try {
                    // 1. Call DashScope
                    const prompt = `Delicious Chinese food photography, ${dishName}, high quality, studio lighting, 4k, minimalist background`;
                    const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${DASHSCOPE_API_KEY}`, 'X-DashScope-Async': 'enable' },
                        body: JSON.stringify({ model: "wanx-v1", input: { prompt: prompt }, parameters: { size: "1024*1024", n: 1 } })
                    });
                    
                    if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
                    
                    const initialData = await response.json();
                    if(!initialData.output) throw new Error(initialData.message || "API Error");
                    const taskId = initialData.output.task_id;

                    // 2. Poll Result
                    let imageUrl = null;
                    for(let i=0; i<15; i++) { 
                        await new Promise(r => setTimeout(r, 2000));
                        const taskResp = await fetch(`https://dashscope.aliyuncs.com/api/v1/tasks/${taskId}`, { headers: { 'Authorization': `Bearer ${DASHSCOPE_API_KEY}` } });
                        const taskData = await taskResp.json();
                        if (taskData.output.task_status === 'SUCCEEDED') { imageUrl = taskData.output.results[0].url; break; }
                        if (taskData.output.task_status === 'FAILED') throw new Error("ç”Ÿå›¾ä»»åŠ¡å¤±è´¥");
                    }
                    if (!imageUrl) throw new Error("ç”Ÿå›¾è¶…æ—¶");

                    // 3. Save Cache (Skip upload if CORS fails to simplify demo)
                    // In a real app, you MUST upload to Supabase to avoid link expiry.
                    // Here we try to upload, if fail, fallback to raw link.
                    try {
                        // Attempt to upload to Supabase Storage
                        // This might fail if CORS is strict on Aliyun side
                        // If you set up Supabase Storage correctly as PUBLIC, this is best.
                        /* const imgBlob = await fetch(imageUrl).then(r => r.blob());
                        const fileName = `${Date.now()}_${Math.random().toString(36).substring(7)}.png`;
                        await supabaseClient.storage.from('dish-images').upload(fileName, imgBlob);
                        const { data: { publicUrl } } = supabaseClient.storage.from('dish-images').getPublicUrl(fileName);
                        imageUrl = publicUrl; 
                        */
                    } catch (uploadErr) { console.warn("Storage upload skipped:", uploadErr); }

                    // Save mapping to DB
                    await supabaseClient.from('dish_images').insert([{ dish_name: dishName, image_url: imageUrl }]);
                    state.dishImages[dishName] = imageUrl;
                    return imageUrl;

                } catch (e) {
                    console.error(e);
                    // Fallback image so flow doesn't break
                    return `https://via.placeholder.com/800x600?text=${encodeURIComponent(dishName)}`;
                } finally {
                    document.getElementById('ai-loader').classList.add('hidden');
                }
            },

            addDishGeneric: async (isTemplate, dateStr, weekDay) => {
                const name = document.getElementById(isTemplate ? 'tpl-name' : 'new-name').value.trim();
                const meal = document.getElementById(isTemplate ? 'tpl-meal' : 'new-meal').value;
                const price = document.getElementById(isTemplate ? 'tpl-price' : 'new-price').value || 0;
                
                if(!name) return app.showToast("è¯·è¾“å…¥èœå“åç§°", false);

                // Get Image (Will handle error internally)
                const imageUrl = await app.getDishImage(name);
                
                const newDish = { name, meal, price, serve_date: dateStr, week_day: weekDay, is_template: isTemplate, votes: 0, score: 0, image_url: imageUrl };
                
                const { error } = await supabaseClient.from('dishes').insert([newDish]);
                if(!error) { 
                    app.showToast('å‘å¸ƒæˆåŠŸ'); 
                    document.getElementById(isTemplate ? 'add-template-form' : 'add-dish-form').reset(); 
                } else app.showToast(error.message, false);
            },

            addDish: (e) => { e.preventDefault(); app.addDishGeneric(false, document.getElementById('new-date').value, null); },
            addTemplateDish: (e) => { e.preventDefault(); app.addDishGeneric(true, null, state.currentTemplateDay); },

            generateNextWeek: async () => {
                if(!confirm(`ç¡®å®šè¦å°†æ‰€æœ‰æ¨¡æ¿åº”ç”¨åˆ°ä¸‹å‘¨å—ï¼Ÿ`)) return;
                const nextWeekStart = new Date();
                nextWeekStart.setDate(nextWeekStart.getDate() + (1 + 7 - nextWeekStart.getDay()) % 7);
                const inserts = [];
                for (let i = 0; i < 7; i++) {
                    const targetDate = new Date(nextWeekStart); targetDate.setDate(nextWeekStart.getDate() + i);
                    const dayOfWeek = targetDate.getDay();
                    state.templates.filter(t => t.week_day === dayOfWeek).forEach(t => {
                        inserts.push({ name: t.name, meal: t.meal, price: t.price, serve_date: targetDate.toISOString().split('T')[0], is_template: false, votes: 0, score: 0, image_url: t.image_url });
                    });
                }
                if(inserts.length === 0) return app.showToast("æ²¡æœ‰æ¨¡æ¿æ•°æ®", false);
                const { error } = await supabaseClient.from('dishes').insert(inserts);
                if(!error) { app.showToast(`å·²ç”Ÿæˆ ${inserts.length} é“èœå“`); app.switchAdminMode('daily'); }
            },

            deleteDish: async (id) => { if(confirm('ç¡®å®šåˆ é™¤è¯¥èœå“ï¼Ÿ')) await supabaseClient.from('dishes').delete().eq('id', id); },

            // --- INTERACTIONS ---
            submitVote: async (id, star) => {
                const d = state.dishes.find(x => x.id === id);
                if(!d) return;
                await supabaseClient.from('dishes').update({ votes: (d.votes||0)+1, score: (d.score||0)+star }).eq('id', id);
                app.showToast(`å·²è¯„åˆ† ${star} æ˜Ÿ!`);
            },
            openCommentModal: (id, name) => {
                document.getElementById('modal-dish-id-hidden').value = id;
                document.getElementById('modal-dish-name').innerText = name;
                document.getElementById('comment-modal').classList.remove('hidden');
            },
            closeCommentModal: () => document.getElementById('comment-modal').classList.add('hidden'),
            submitCommentAction: async () => {
                const text = document.getElementById('comment-text').value.trim();
                const dishId = document.getElementById('modal-dish-id-hidden').value;
                const dish = state.dishes.find(d => d.id == dishId); 
                if(!text || !dishId || !dish) return;
                
                const { error } = await supabaseClient.from('comments').insert([{ dish_id: dishId, dish_name: dish.name, text: text, created_at: new Date().toISOString() }]);
                if(!error) { app.showToast('è¯„è®ºå·²æäº¤'); app.closeCommentModal(); document.getElementById('comment-text').value = ''; }
            },

            // --- UI HELPERS ---
            showToast: (msg, success=true) => {
                const toast = document.getElementById('toast');
                const msgEl = document.getElementById('toast-msg');
                const iconEl = document.getElementById('toast-icon');
                msgEl.innerText = msg;
                iconEl.className = success ? "fa-solid fa-circle-check text-apple-green text-xl" : "fa-solid fa-circle-exclamation text-apple-red text-xl";
                toast.classList.remove('-translate-y-24');
                setTimeout(() => toast.classList.add('-translate-y-24'), 3000);
            },

            checkAdminAccess: () => app.switchView('admin'),
            login: (e) => { 
                e.preventDefault(); 
                if(document.getElementById('admin-user').value==='gly123' && document.getElementById('admin-pass').value==='123456'){
                    state.isAdmin=true;
                    document.getElementById('admin-login-panel').classList.add('hidden'); 
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                } else app.showToast("è´¦å·æˆ–å¯†ç é”™è¯¯", false);
            },
            logout: () => location.reload(),
            
            switchAdminMode: (mode) => {
                state.adminMode = mode;
                document.getElementById('admin-mode-daily').classList.toggle('hidden', mode!=='daily');
                document.getElementById('admin-mode-weekly').classList.toggle('hidden', mode!=='weekly');
                const btnDaily = document.getElementById('adm-daily-btn');
                const btnWeekly = document.getElementById('adm-weekly-btn');
                if(mode === 'daily') {
                    btnDaily.className = "px-5 py-2 bg-white rounded-full shadow-sm text-xs font-semibold text-black transition-all";
                    btnWeekly.className = "px-5 py-2 text-apple-gray rounded-full text-xs font-semibold hover:text-black transition-all";
                } else {
                    btnWeekly.className = "px-5 py-2 bg-white rounded-full shadow-sm text-xs font-semibold text-black transition-all";
                    btnDaily.className = "px-5 py-2 text-apple-gray rounded-full text-xs font-semibold hover:text-black transition-all";
                }
            },

            switchView: (v) => { 
                state.currentView=v; 
                ['home','stats','admin'].forEach(id=>{
                    const btn = document.getElementById('nav-'+id);
                    const mobBtn = document.getElementById('mob-'+id);
                    if(id===v) {
                        btn.className = "hover:text-apple-blue opacity-100 font-semibold transition-all text-apple-blue";
                        mobBtn.className = "w-12 h-12 rounded-full flex items-center justify-center text-xl bg-black text-white transition-all";
                    } else {
                        btn.className = "hover:text-apple-blue opacity-80 transition-all";
                        mobBtn.className = "w-12 h-12 rounded-full flex items-center justify-center text-xl text-gray-400 hover:text-black transition-all";
                    }
                });
                ['view-home','view-stats','view-admin'].forEach(el=>document.getElementById(el).classList.add('hidden')); 
                document.getElementById('view-'+v).classList.remove('hidden'); 
                if(v==='stats') app.renderAll(); 
            },

            setTemplateDay: (idx) => { state.currentTemplateDay=idx; app.renderWeekdaySelector(); app.renderAll(); },
            renderWeekdaySelector: () => { 
                document.getElementById('weekday-selector').innerHTML=weekdays.map((day,idx)=>`
                    <button onclick="app.setTemplateDay(${idx})" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-semibold transition-all ${idx===state.currentTemplateDay?'bg-black text-white shadow-md':'bg-[#F5F5F7] text-gray-500 hover:bg-gray-200'}">${day}</button>
                `).join(''); 
                document.getElementById('current-template-day-name').innerText=weekdays[state.currentTemplateDay]; 
            },
            
            setupRealtime: () => { supabaseClient.channel('db').on('postgres_changes',{event:'*',schema:'public',table:'dishes'},app.fetchData).on('postgres_changes',{event:'*',schema:'public',table:'comments'},app.fetchData).on('postgres_changes',{event:'*',schema:'public',table:'dish_images'},app.fetchData).subscribe(); },

            renderAll: () => {
                const todayDishes = state.dishes.filter(d => d.serve_date === state.todayStr);
                
                app.renderGrid('grid-breakfast', todayDishes.filter(d => d.meal === 'breakfast'), false);
                app.renderGrid('grid-lunch', todayDishes.filter(d => d.meal === 'lunch'), false);
                app.renderGrid('grid-dinner', todayDishes.filter(d => d.meal === 'dinner'), false);

                const tmrw = new Date(); tmrw.setDate(tmrw.getDate()+1); const tmrwStr = tmrw.toISOString().split('T')[0];
                const tmrwDishes = state.dishes.filter(d => d.serve_date === tmrwStr);
                app.renderGrid('tmrw-grid', tmrwDishes, true);

                if(state.currentView === 'stats') {
                    const sorted = [...state.dishes].sort((a,b) => (b.votes||0) - (a.votes||0)).slice(0, 10);
                    document.getElementById('hot-list').innerHTML = sorted.map((d, i) => {
                        const avg = d.votes>0?(d.score/d.votes).toFixed(1):'0.0';
                        return `
                        <div class="bg-white rounded-[24px] p-4 flex items-center gap-5 shadow-sm border border-gray-100 card-hover">
                            <div class="text-2xl font-bold w-8 text-center text-black/20 italic">#${i+1}</div>
                            <img src="${d.image_url || 'https://via.placeholder.com/100?text=Food'}" class="w-16 h-16 rounded-[18px] object-cover bg-[#F5F5F7]">
                            <div class="flex-grow">
                                <h3 class="font-semibold text-[17px] text-[#1D1D1F]">${d.name}</h3>
                                <div class="flex items-center gap-3 text-xs mt-1 text-gray-500 font-medium">
                                    <span class="flex items-center text-orange-500"><i class="fa-solid fa-star mr-1"></i> ${avg}</span>
                                    <span>${d.votes} äººå“å°</span>
                                </div>
                            </div>
                        </div>`;
                    }).join('');

                    document.getElementById('live-comments-list').innerHTML = state.comments.map(c => `
                        <div class="bg-[#F5F5F7] p-5 rounded-[20px] text-sm mb-3">
                            <div class="flex justify-between mb-2">
                                <span class="font-semibold text-black bg-white px-2 py-1 rounded-md shadow-sm text-xs">${c.dish_name||'Dish'}</span>
                                <span class="text-[10px] text-gray-400 font-medium">${new Date(c.created_at).toLocaleTimeString().slice(0,5)}</span>
                            </div>
                            <p class="text-[#1D1D1F] leading-relaxed text-[15px]">${c.text}</p>
                        </div>
                    `).join('');
                }

                const adminListHtml = (list, isTpl) => list.map(d => `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50 last:border-0">
                        ${!isTpl?`<td class="px-6 py-4 font-mono text-xs text-gray-400">${d.serve_date}</td>`:''}
                        <td class="px-6 py-4"><img src="${d.image_url || ''}" class="w-10 h-10 rounded-xl bg-gray-100 object-cover border border-gray-100 shadow-sm" onerror="this.style.display='none'"></td>
                        <td class="px-6 py-4 font-semibold text-[#1D1D1F]">${d.name}</td>
                        <td class="px-6 py-4"><span class="px-3 py-1 bg-gray-100 rounded-full text-xs font-medium text-gray-600 capitalize">${d.meal}</span></td>
                        <td class="px-6 py-4 text-right"><button onclick="app.deleteDish(${d.id})" class="text-apple-gray hover:text-apple-red transition-colors"><i class="fa-regular fa-trash-can"></i></button></td>
                    </tr>`).join('');
                document.getElementById('admin-list').innerHTML = adminListHtml(state.dishes, false);
                document.getElementById('template-list').innerHTML = adminListHtml(state.templates.filter(t=>t.week_day===state.currentTemplateDay), true);
            },

            renderGrid: (elId, list, isPreview) => {
                const el = document.getElementById(elId);
                if(list.length===0) return el.innerHTML = `<div class="col-span-full py-16 text-center text-gray-300 font-medium text-sm">æš‚æ— ä¾›åº”å®‰æ’</div>`;
                el.innerHTML = list.map(d => {
                    const avg = d.votes>0?(d.score/d.votes).toFixed(1):'0.0';
                    const cls = isPreview?'opacity-60 grayscale hover:opacity-100 hover:grayscale-0 transition-all duration-500':'card-hover shadow-soft';
                    return `
                    <div class="bg-white rounded-[32px] p-5 ${cls} relative group border border-white/60">
                        <div class="h-48 w-full rounded-[24px] bg-[#F5F5F7] mb-5 relative overflow-hidden">
                            <img src="${d.image_url || ''}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" onerror="this.src='https://via.placeholder.com/400x300?text=TastyTrack';this.classList.add('opacity-30', 'p-10');">
                            <div class="absolute top-3 right-3 bg-white/90 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold shadow-sm border border-white/50">Â¥${d.price}</div>
                        </div>
                        <div class="flex justify-between items-start mb-3 px-1">
                            <h3 class="font-bold text-xl text-[#1D1D1F] tracking-tight leading-tight">${d.name}</h3>
                            <div class="flex items-center gap-1 bg-[#F5F5F7] px-2 py-1 rounded-lg">
                                <i class="fa-solid fa-star text-orange-400 text-[10px]"></i>
                                <span class="font-bold text-xs text-[#1D1D1F]">${avg}</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center px-1">
                            <div class="flex gap-1">
                                ${!isPreview?[1,2,3,4,5].map(s=>`<button onclick="app.submitVote(${d.id},${s})" class="w-8 h-8 rounded-full hover:bg-orange-50 hover:text-orange-500 transition-colors text-gray-200 flex items-center justify-center"><i class="fa-solid fa-star text-xs"></i></button>`).join(''):'<span class="text-xs text-gray-400 font-medium">æ˜æ—¥å¼€å¯</span>'}
                            </div>
                            <button onclick="app.openCommentModal(${d.id}, '${d.name}')" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center hover:scale-110 active:scale-95 transition-all shadow-md">
                                <i class="fa-solid fa-pen text-xs"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            }
        };

        document.getElementById('login-form').addEventListener('submit', app.login);
        document.getElementById('add-dish-form').addEventListener('submit', app.addDish);
        document.getElementById('add-template-form').addEventListener('submit', app.addTemplateDish);
        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>
