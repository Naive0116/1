<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TastyTrack | æ™ºæ…§é£Ÿå ‚ Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', '"San Francisco"', 'Helvetica', 'Arial', 'sans-serif'] },
                    colors: {
                        ios: { bg: '#F5F5F7', card: '#FFFFFF', blue: '#007AFF', green: '#34C759', red: '#FF3B30', gray: '#8E8E93', text: '#1D1D1F' }
                    },
                    boxShadow: {
                        'apple': '0 4px 20px rgba(0, 0, 0, 0.04)',
                        'apple-hover': '0 8px 30px rgba(0, 0, 0, 0.08)',
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F5F5F7; -webkit-font-smoothing: antialiased; }
        .glass-nav { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .loader { width: 20px; height: 20px; border: 2px solid #E5E5EA; border-bottom-color: #007AFF; border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Preview Card Style */
        .preview-card { opacity: 0.8; border: 1px dashed #d1d5db; }
        .active-day-btn { background-color: #000; color: #fff; }
        .inactive-day-btn { background-color: #f3f4f6; color: #6b7280; }
    </style>
</head>
<body class="text-ios-text font-sans min-h-screen pb-24">

    <!-- Loading -->
    <div id="init-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="loader mb-4 w-8 h-8 border-4"></div>
        <p class="text-gray-400 text-sm font-medium">System Initializing...</p>
    </div>

    <!-- Nav -->
    <nav class="glass-nav sticky top-0 z-50 w-full h-16">
        <div class="max-w-6xl mx-auto px-4 h-full flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.switchView('home')">
                <div class="bg-black text-white w-8 h-8 rounded-lg flex items-center justify-center text-sm shadow-md"><i class="fa-solid fa-utensils"></i></div>
                <span class="font-semibold text-lg tracking-tight text-black">TastyTrack</span>
            </div>
            <div class="hidden md:flex space-x-1 bg-gray-100/50 p-1 rounded-full backdrop-blur-sm">
                <button onclick="app.switchView('home')" id="nav-home" class="px-5 py-1.5 rounded-full text-sm font-medium transition-all text-gray-500 hover:text-black">ä¸»é¡µ</button>
                <button onclick="app.switchView('stats')" id="nav-stats" class="px-5 py-1.5 rounded-full text-sm font-medium transition-all text-gray-500 hover:text-black">çœ‹æ¿</button>
                <button onclick="app.checkAdminAccess()" id="nav-admin" class="px-5 py-1.5 rounded-full text-sm font-medium transition-all text-gray-500 hover:text-black">ç®¡ç†åå°</button>
            </div>
            <button onclick="app.openConfig()" class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition-colors text-gray-600"><i class="fa-solid fa-gear text-sm"></i></button>
        </div>
    </nav>

    <!-- Mobile Nav -->
    <div class="md:hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-black/80 backdrop-blur-xl text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-8">
        <button onclick="app.switchView('home')"><i class="fa-solid fa-house text-xl"></i></button>
        <button onclick="app.switchView('stats')"><i class="fa-solid fa-chart-pie text-xl"></i></button>
        <button onclick="app.checkAdminAccess()"><i class="fa-solid fa-lock text-xl"></i></button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="max-w-6xl mx-auto px-4 pt-8 animate-fade-in">

        <!-- VIEW 1: HOME (TODAY & PREVIEW) -->
        <section id="view-home" class="space-y-10">
            <!-- Header -->
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold tracking-tight text-black">ä»Šæ—¥ä¾›åº”</h1>
                    <p class="text-gray-500 mt-1 flex items-center gap-2">
                        <span id="display-date-today">YYYY-MM-DD</span> 
                        <span id="display-weekday-today" class="bg-gray-100 px-2 py-0.5 rounded text-xs">å‘¨-</span>
                    </p>
                </div>
                <!-- Meal Filter -->
                <div class="bg-white p-1 rounded-full shadow-apple inline-flex">
                    <button onclick="app.filterMeal('breakfast')" id="btn-breakfast" class="px-4 py-1.5 rounded-full text-xs font-medium text-gray-500">æ—©é¤</button>
                    <button onclick="app.filterMeal('lunch')" id="btn-lunch" class="px-4 py-1.5 rounded-full text-xs font-medium bg-black text-white shadow-md">åˆé¤</button>
                    <button onclick="app.filterMeal('dinner')" id="btn-dinner" class="px-4 py-1.5 rounded-full text-xs font-medium text-gray-500">æ™šé¤</button>
                </div>
            </div>

            <!-- Today's Grid -->
            <div id="today-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- JS Injected -->
            </div>

            <div class="border-t border-gray-200 pt-8">
                <h2 class="text-2xl font-bold tracking-tight text-gray-400 flex items-center gap-2 mb-6">
                    <i class="fa-regular fa-calendar-check"></i> æ˜æ—¥é¢„å‘Š
                    <span class="text-sm font-normal text-gray-400 bg-gray-100 px-2 py-1 rounded-lg" id="display-date-tmrw">Loading...</span>
                </h2>
                <div id="tmrw-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 opacity-75 hover:opacity-100 transition-opacity">
                    <!-- JS Injected -->
                </div>
            </div>
        </section>

        <!-- VIEW 2: STATS -->
        <section id="view-stats" class="hidden space-y-8">
            <div class="bg-white rounded-3xl p-8 shadow-apple border border-white/50">
                <h2 class="text-2xl font-bold tracking-tight mb-6">ç‚¹è¯„çƒ­åº¦è¶‹åŠ¿</h2>
                <div class="chart-container h-64">
                    <canvas id="rankingChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-3xl p-8 shadow-apple border border-white/50">
                <h2 class="text-2xl font-bold tracking-tight mb-6">å®æ—¶è¯„ä»·å¢™</h2>
                <div id="live-comments-list" class="space-y-4 max-h-[500px] overflow-y-auto pr-2 no-scrollbar"></div>
            </div>
        </section>

        <!-- VIEW 3: ADMIN -->
        <section id="view-admin" class="hidden">
            <!-- Login -->
            <div id="admin-login-panel" class="max-w-md mx-auto mt-20 bg-white rounded-3xl shadow-2xl p-10 text-center">
                <h2 class="text-2xl font-bold mb-6">ç®¡ç†å‘˜ç™»å½•</h2>
                <form id="login-form" class="space-y-4">
                    <input type="text" id="admin-user" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="Account (admin)">
                    <input type="password" id="admin-pass" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="Password (admin123)">
                    <button type="submit" class="w-full bg-black text-white font-bold rounded-xl py-3 mt-4">Login</button>
                </form>
            </div>

            <!-- Dashboard -->
            <div id="admin-dashboard" class="hidden space-y-8">
                <div class="flex justify-between items-center bg-black text-white rounded-3xl p-8 shadow-apple-hover">
                    <div><h2 class="text-3xl font-bold">åå°ç®¡ç†</h2><p class="text-gray-400 text-sm mt-1">æ’æœŸä¸ç»´æŠ¤</p></div>
                    <div class="flex gap-2">
                        <button onclick="app.switchAdminMode('daily')" class="px-4 py-2 bg-white/20 rounded-full text-xs backdrop-blur-md hover:bg-white/30 transition">æ¯æ—¥æ˜ç»†</button>
                        <button onclick="app.switchAdminMode('weekly')" class="px-4 py-2 bg-ios-blue text-white rounded-full text-xs shadow-lg hover:brightness-110 transition">å‘¨å¸¸æ¨¡æ¿</button>
                        <button onclick="app.logout()" class="px-4 py-2 bg-red-500/20 text-red-300 rounded-full text-xs hover:bg-red-500/30 transition">é€€å‡º</button>
                    </div>
                </div>

                <!-- MODE A: WEEKLY TEMPLATE (Hidden by default) -->
                <div id="admin-mode-weekly" class="hidden space-y-6 animate-fade-in">
                    <div class="bg-blue-50 border border-blue-100 p-4 rounded-2xl flex items-start gap-3">
                        <i class="fa-solid fa-circle-info text-blue-500 mt-1"></i>
                        <div class="text-sm text-blue-800">
                            <p class="font-bold">è¿™æ˜¯å‘¨å¸¸æ¨¡æ¿è®¾ç½®</p>
                            <p>åœ¨è¿™é‡Œè®¾ç½®æ¯å‘¨ä¸€åˆ°å‘¨æ—¥çš„å›ºå®šèœè°±ã€‚è®¾ç½®å®Œæˆåï¼Œç‚¹å‡»ä¸‹æ–¹çš„â€œç”Ÿæˆä¸‹å‘¨èœå•â€å°†æ¨¡æ¿åº”ç”¨åˆ°å…·ä½“æ—¥æœŸã€‚</p>
                        </div>
                    </div>

                    <!-- Weekday Selector -->
                    <div class="flex overflow-x-auto gap-2 pb-2 no-scrollbar" id="weekday-selector">
                        <!-- JS Generated Buttons -->
                    </div>

                    <!-- Add Template Dish -->
                    <div class="bg-white p-6 rounded-3xl shadow-apple">
                        <h3 class="font-bold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-calendar-week text-ios-blue"></i> 
                            è®¾ç½® <span id="current-template-day-name" class="text-ios-blue">å‘¨ä¸€</span> æ¨¡æ¿
                        </h3>
                        <form id="add-template-form" class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <select id="tpl-meal" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3">
                                    <option value="breakfast">æ—©é¤</option>
                                    <option value="lunch">åˆé¤</option>
                                    <option value="dinner">æ™šé¤</option>
                                </select>
                                <input type="number" id="tpl-price" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="ä»·æ ¼ (Â¥)">
                            </div>
                            <input type="text" id="tpl-name" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="èœå“åç§° (ä¾‹å¦‚: æ¨¡æ¿-çº¢çƒ§è‚‰)" required>
                            <button type="submit" class="w-full bg-ios-blue text-white font-bold rounded-xl py-3 hover:brightness-105 transition-all">æ·»åŠ åˆ°è¯¥æ—¥æ¨¡æ¿</button>
                        </form>
                    </div>

                    <!-- Template List -->
                    <div class="bg-white rounded-3xl shadow-apple overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                            <h3 class="font-bold text-gray-500 text-sm">å½“å‰é€‰ä¸­æ—¥æœŸçš„æ¨¡æ¿èœå“</h3>
                            <button onclick="app.generateNextWeek()" class="bg-black text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:scale-105 transition-transform">
                                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> åº”ç”¨æ¨¡æ¿åˆ°ä¸‹å‘¨
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-white text-gray-400"><tr><th class="px-6 py-3">èœå</th><th class="px-6 py-3">æ—¶æ®µ</th><th class="px-6 py-3 text-right">æ“ä½œ</th></tr></thead>
                                <tbody id="template-list" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- MODE B: DAILY MANAGEMENT (Default) -->
                <div id="admin-mode-daily" class="space-y-6 animate-fade-in">
                    <!-- Add Specific Dish -->
                    <div class="bg-white p-6 rounded-3xl shadow-apple">
                        <h3 class="font-bold mb-4">æ·»åŠ /è°ƒæ•´ç‰¹å®šæ—¥æœŸèœå“</h3>
                        <form id="add-dish-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">æ—¥æœŸ</label>
                                    <input type="date" id="new-date" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3 focus:ring-2 focus:ring-ios-blue/30" required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">æ—¶æ®µ</label>
                                    <select id="new-meal" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3">
                                        <option value="breakfast">æ—©é¤</option>
                                        <option value="lunch">åˆé¤</option>
                                        <option value="dinner">æ™šé¤</option>
                                    </select>
                                </div>
                            </div>
                            <input type="text" id="new-name" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="èœå“åç§°" required>
                            <input type="number" id="new-price" class="w-full bg-gray-50 border-0 rounded-xl px-4 py-3" placeholder="ä»·æ ¼ (Â¥)">
                            <button type="submit" class="w-full bg-ios-green text-white font-bold rounded-xl py-3 hover:brightness-105 transition-all">å‘å¸ƒåˆ°è¯¥æ—¥</button>
                        </form>
                    </div>

                    <!-- Full List -->
                    <div class="bg-white rounded-3xl shadow-apple overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-gray-50"><h3 class="font-bold text-gray-500 text-sm">å†å²èœå“æ˜ç»† (å®é™…æ’æœŸ)</h3></div>
                        <div class="overflow-x-auto max-h-[400px]">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-white text-gray-400"><tr><th class="px-6 py-3">æ—¥æœŸ</th><th class="px-6 py-3">èœå</th><th class="px-6 py-3">æ—¶æ®µ</th><th class="px-6 py-3 text-right">æ“ä½œ</th></tr></thead>
                                <tbody id="admin-list" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Comment Modal -->
    <div id="comment-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 animate-fade-in">
            <h3 class="font-bold text-lg mb-4">å†™ä¸‹ä½ çš„è¯„ä»·</h3>
            <input type="hidden" id="comment-dish-id">
            <input type="hidden" id="comment-dish-name">
            <textarea id="comment-text" class="w-full bg-gray-50 rounded-xl p-3 text-sm h-32 focus:outline-none focus:ring-2 focus:ring-ios-blue/50" placeholder="å‘³é“å¦‚ä½•ï¼Ÿæœ‰ä»€ä¹ˆå»ºè®®ï¼Ÿ"></textarea>
            <div class="flex gap-3 mt-4">
                <button onclick="document.getElementById('comment-modal').classList.add('hidden')" class="flex-1 py-2 text-sm bg-gray-100 rounded-xl font-bold text-gray-500">å–æ¶ˆ</button>
                <button onclick="app.submitCommentAction()" class="flex-1 py-2 text-sm bg-black text-white rounded-xl font-bold">æäº¤</button>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm">
            <h3 class="font-bold mb-4">Database Config</h3>
            <form id="config-form" class="space-y-3">
                <input id="input-supabase-url" class="w-full border rounded p-2 text-xs" placeholder="URL">
                <input id="input-supabase-key" class="w-full border rounded p-2 text-xs" placeholder="Key" type="password">
                <button class="w-full bg-black text-white py-2 rounded font-bold text-sm">Save</button>
            </form>
            <button onclick="app.closeConfig()" class="w-full text-center text-xs text-gray-400 mt-2">Close</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”´ å¡«å…¥ä½ çš„ Supabase ä¿¡æ¯
        // ==========================================
        let supabaseUrl = 'https://zjwqbyijjxoalzchtjrz.supabase.co'; 
        let supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpqd3FieWlqanhvYWx6Y2h0anJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyNDM0MTksImV4cCI6MjA4MDgxOTQxOX0.FbPI3J9a8AsdvtpiNIeZ0Ia8dMXutFbuTc_T0ymnFhw'; 
        // ==========================================

        if(localStorage.getItem('sb_url')) supabaseUrl = localStorage.getItem('sb_url');
        if(localStorage.getItem('sb_key')) supabaseKey = localStorage.getItem('sb_key');

        let supabaseClient = null;
        const state = { 
            currentView: 'home', 
            currentMeal: 'lunch', 
            isAdmin: false, 
            dishes: [], // Specific date dishes
            templates: [], // Rotating template dishes
            comments: [],
            todayStr: new Date().toISOString().split('T')[0],
            rankingChart: null,
            adminMode: 'daily', // 'daily' or 'weekly'
            currentTemplateDay: 1 // 1=Mon, 0=Sun
        };

        const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

        const app = {
            init: async () => {
                // Set Header Dates
                const today = new Date();
                document.getElementById('display-date-today').innerText = state.todayStr;
                document.getElementById('display-weekday-today').innerText = weekdays[today.getDay()];
                
                const tmrw = new Date(today); tmrw.setDate(tmrw.getDate()+1);
                document.getElementById('display-date-tmrw').innerText = tmrw.toISOString().split('T')[0] + " " + weekdays[tmrw.getDay()];
                document.getElementById('new-date').value = state.todayStr;

                app.renderWeekdaySelector();

                if (supabaseUrl.includes('YOUR_PROJECT') || !supabaseUrl) {
                    alert('è¯·ç‚¹å‡»å³ä¸Šè§’é½¿è½®é…ç½®æ•°æ®åº“è¿æ¥');
                    document.getElementById('init-overlay').classList.add('hidden');
                } else {
                    const { createClient } = supabase;
                    supabaseClient = createClient(supabaseUrl, supabaseKey);
                    await app.fetchData();
                    app.setupRealtime();
                    document.getElementById('init-overlay').classList.add('opacity-0', 'pointer-events-none');
                }
            },

            fetchData: async () => {
                // Fetch REAL dishes (is_template = false)
                const { data: d } = await supabaseClient.from('dishes').select('*').eq('is_template', false).order('serve_date', {ascending: true});
                // Fetch TEMPLATES (is_template = true)
                const { data: t } = await supabaseClient.from('dishes').select('*').eq('is_template', true).order('created_at', {ascending: true});
                
                const { data: c } = await supabaseClient.from('comments').select('*').order('created_at', {ascending: false}).limit(30);
                
                state.dishes = d || [];
                state.templates = t || [];
                state.comments = c || [];
                app.renderAll();
            },

            // --- ADMIN LOGIC ---
            checkAdminAccess: () => app.switchView('admin'),
            login: (e) => {
                e.preventDefault();
                const u = document.getElementById('admin-user').value;
                const p = document.getElementById('admin-pass').value;
                if (u === 'admin' && p === 'admin123') {
                    state.isAdmin = true;
                    document.getElementById('admin-login-panel').classList.add('hidden');
                    document.getElementById('admin-dashboard').classList.remove('hidden');
                } else alert("è´¦å·å¯†ç é”™è¯¯ (admin/admin123)");
            },
            logout: () => location.reload(),

            switchAdminMode: (mode) => {
                state.adminMode = mode;
                document.getElementById('admin-mode-daily').classList.toggle('hidden', mode !== 'daily');
                document.getElementById('admin-mode-weekly').classList.toggle('hidden', mode !== 'weekly');
            },

            // 1. Add Specific Date Dish
            addDish: async (e) => {
                e.preventDefault();
                const newDish = {
                    name: document.getElementById('new-name').value,
                    meal: document.getElementById('new-meal').value,
                    price: document.getElementById('new-price').value,
                    serve_date: document.getElementById('new-date').value,
                    is_template: false,
                    votes: 0, score: 0,
                    img_color: ["bg-red-50", "bg-blue-50", "bg-green-50", "bg-orange-50"][Math.floor(Math.random()*4)]
                };
                const { error } = await supabaseClient.from('dishes').insert([newDish]);
                if(!error) { alert('å‘å¸ƒæˆåŠŸ'); document.getElementById('add-dish-form').reset(); }
            },

            // 2. Add Template Dish
            addTemplateDish: async (e) => {
                e.preventDefault();
                const newTpl = {
                    name: document.getElementById('tpl-name').value,
                    meal: document.getElementById('tpl-meal').value,
                    price: document.getElementById('tpl-price').value,
                    week_day: state.currentTemplateDay, // 0-6
                    is_template: true,
                    votes: 0, score: 0,
                    img_color: ["bg-purple-50", "bg-pink-50", "bg-indigo-50"][Math.floor(Math.random()*3)]
                };
                const { error } = await supabaseClient.from('dishes').insert([newTpl]);
                if(!error) { document.getElementById('add-template-form').reset(); }
            },

            // 3. GENERATE NEXT WEEK
            generateNextWeek: async () => {
                if(!confirm(`ç¡®å®šè¦å°†å½“å‰æ‰€æœ‰æ¨¡æ¿åº”ç”¨åˆ°ä¸‹å‘¨å—ï¼Ÿè¿™ä¼šç”Ÿæˆå®é™…çš„èœå“æ•°æ®ã€‚`)) return;
                
                const nextWeekStart = new Date();
                // Find next Monday
                nextWeekStart.setDate(nextWeekStart.getDate() + (1 + 7 - nextWeekStart.getDay()) % 7);
                
                const inserts = [];
                
                // For each day of next week (0-6 days from next Monday)
                for (let i = 0; i < 7; i++) {
                    const targetDate = new Date(nextWeekStart);
                    targetDate.setDate(nextWeekStart.getDate() + i);
                    const targetDateStr = targetDate.toISOString().split('T')[0];
                    const dayOfWeek = targetDate.getDay(); // 0=Sun, 1=Mon

                    // Find templates for this weekday
                    const daysTemplates = state.templates.filter(t => t.week_day === dayOfWeek);
                    
                    daysTemplates.forEach(t => {
                        inserts.push({
                            name: t.name,
                            meal: t.meal,
                            price: t.price,
                            serve_date: targetDateStr,
                            is_template: false,
                            votes: 0, score: 0,
                            img_color: t.img_color
                        });
                    });
                }

                if(inserts.length === 0) return alert("æ²¡æœ‰è®¾ç½®æ¨¡æ¿ï¼Œæ— æ³•ç”Ÿæˆã€‚");

                const { error } = await supabaseClient.from('dishes').insert(inserts);
                if(error) alert("ç”Ÿæˆå¤±è´¥: " + error.message);
                else {
                    alert(`æˆåŠŸç”Ÿæˆ ${inserts.length} é“èœå“åˆ° ${nextWeekStart.toISOString().split('T')[0]} å¼€å§‹çš„ä¸€å‘¨ï¼ç°åœ¨ä½ å¯ä»¥å»â€œæ¯æ—¥æ˜ç»†â€é‡Œå¾®è°ƒäº†ã€‚`);
                    app.switchAdminMode('daily');
                }
            },

            deleteDish: async (id) => {
                if(confirm('ç¡®å®šåˆ é™¤?')) await supabaseClient.from('dishes').delete().eq('id', id);
            },

            // --- INTERACTIONS ---
            submitVote: async (id, star) => {
                const d = state.dishes.find(x => x.id === id);
                await supabaseClient.from('dishes').update({ votes: (d.votes||0)+1, score: (d.score||0)+star }).eq('id', id);
            },

            openComment: (id, name) => {
                document.getElementById('comment-dish-id').value = id;
                document.getElementById('comment-dish-name').value = name;
                document.getElementById('comment-modal').classList.remove('hidden');
            },

            submitCommentAction: async () => {
                const text = document.getElementById('comment-text').value;
                const dishId = document.getElementById('comment-dish-id').value;
                const dishName = document.getElementById('comment-dish-name').value;
                if(!text) return;

                await supabaseClient.from('comments').insert([{
                    dish_id: dishId, dish_name: dishName, text: text,
                    created_at: new Date().toISOString()
                }]);
                
                document.getElementById('comment-text').value = '';
                document.getElementById('comment-modal').classList.add('hidden');
                alert('è¯„è®ºå·²å‘å¸ƒ');
            },

            // --- RENDER HELPERS ---
            renderWeekdaySelector: () => {
                const container = document.getElementById('weekday-selector');
                container.innerHTML = weekdays.map((day, idx) => `
                    <button onclick="app.setTemplateDay(${idx})" 
                        class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold transition-all ${idx === state.currentTemplateDay ? 'active-day-btn shadow-md' : 'inactive-day-btn'}">
                        ${day}
                    </button>
                `).join('');
                document.getElementById('current-template-day-name').innerText = weekdays[state.currentTemplateDay];
            },

            setTemplateDay: (idx) => {
                state.currentTemplateDay = idx;
                app.renderWeekdaySelector();
                app.renderTemplateList();
            },

            // --- RENDER MAIN ---
            renderAll: () => {
                // 1. Render TODAY
                const todayDishes = state.dishes.filter(d => d.serve_date === state.todayStr && d.meal === state.currentMeal);
                app.renderGrid('today-grid', todayDishes, false);

                // 2. Render TOMORROW
                const tmrw = new Date(); tmrw.setDate(tmrw.getDate() + 1);
                const tmrwStr = tmrw.toISOString().split('T')[0];
                const tmrwDishes = state.dishes.filter(d => d.serve_date === tmrwStr && d.meal === state.currentMeal);
                app.renderGrid('tmrw-grid', tmrwDishes, true);

                // 3. Render Comments
                const commentList = document.getElementById('live-comments-list');
                commentList.innerHTML = state.comments.map(c => `
                    <div class="bg-gray-50 p-4 rounded-2xl text-sm border border-gray-100">
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-gray-800">${c.dish_name || 'èœå“'}</span>
                            <span class="text-xs text-gray-400">${new Date(c.created_at).toLocaleTimeString()}</span>
                        </div>
                        <p class="text-gray-600">${c.text}</p>
                    </div>
                `).join('');

                // 4. Render Admin Lists
                // List A: Daily Real Dishes
                document.getElementById('admin-list').innerHTML = state.dishes.map(d => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 font-mono text-xs text-gray-500">${d.serve_date}</td>
                        <td class="px-6 py-3 font-bold">${d.name}</td>
                        <td class="px-6 py-3 text-xs capitalize text-gray-500">${d.meal}</td>
                        <td class="px-6 py-3 text-right"><button onclick="app.deleteDish(${d.id})" class="text-red-500 font-bold text-xs">åˆ é™¤</button></td>
                    </tr>
                `).join('');
                
                // List B: Templates
                app.renderTemplateList();

                if(state.currentView === 'stats') app.updateCharts();
            },

            renderTemplateList: () => {
                const list = state.templates.filter(t => t.week_day === state.currentTemplateDay);
                const container = document.getElementById('template-list');
                if(list.length === 0) {
                    container.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">è¯¥æ—¥æš‚æ— æ¨¡æ¿ï¼Œè¯·æ·»åŠ </td></tr>';
                    return;
                }
                container.innerHTML = list.map(t => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-3 font-bold text-gray-700">${t.name}</td>
                        <td class="px-6 py-3 text-xs capitalize text-gray-500">${t.meal}</td>
                        <td class="px-6 py-3 text-right"><button onclick="app.deleteDish(${t.id})" class="text-red-500 font-bold text-xs">ç§»é™¤æ¨¡æ¿</button></td>
                    </tr>
                `).join('');
            },

            renderGrid: (elementId, list, isPreview) => {
                const el = document.getElementById(elementId);
                if(list.length === 0) {
                    el.innerHTML = `<div class="col-span-full py-10 text-center text-gray-400 text-sm">æš‚æ— å®‰æ’</div>`;
                    return;
                }
                el.innerHTML = list.map(d => {
                    const avg = d.votes > 0 ? (d.score / d.votes).toFixed(1) : '0.0';
                    const previewClass = isPreview ? 'preview-card grayscale hover:grayscale-0 transition-all' : 'shadow-apple hover:-translate-y-1 transition-transform';
                    
                    return `
                    <div class="bg-white rounded-3xl p-5 ${previewClass} border border-white/60 relative group">
                        <div class="h-32 w-full rounded-2xl ${d.img_color || 'bg-gray-100'} flex items-center justify-center mb-4 relative">
                            <i class="fa-solid fa-utensils text-3xl text-black/10"></i>
                            <div class="absolute top-2 right-2 bg-white/90 backdrop-blur-md px-2 py-1 rounded-lg text-xs font-bold shadow-sm">Â¥${d.price}</div>
                        </div>
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-gray-900">${d.name}</h3>
                            <div class="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded-lg">
                                <i class="fa-solid fa-star text-yellow-400 text-xs"></i>
                                <span class="font-bold text-sm text-yellow-700">${avg}</span>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center">
                            <div class="flex gap-1">
                                ${!isPreview ? [1,2,3,4,5].map(s => `<button onclick="app.submitVote(${d.id}, ${s})" class="w-7 h-7 rounded-full bg-gray-50 hover:bg-yellow-400 hover:text-white transition-colors text-gray-300 flex items-center justify-center"><i class="fa-solid fa-star text-[10px]"></i></button>`).join('') : '<span class="text-xs text-gray-400">æ˜æ—¥å¼€å¯</span>'}
                            </div>
                            <button onclick="app.openComment(${d.id}, '${d.name}')" class="text-gray-400 hover:text-ios-blue transition-colors">
                                <i class="fa-regular fa-comment-dots text-lg"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            },

            updateCharts: () => {
                const ctx = document.getElementById('rankingChart');
                if(!ctx) return;
                const sorted = [...state.dishes].sort((a,b) => (b.votes>0?b.score/b.votes:0) - (a.votes>0?a.score/a.votes:0)).slice(0,5);
                
                if (state.rankingChart) state.rankingChart.destroy();

                state.rankingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(d => d.name),
                        datasets: [{ label: 'Score', data: sorted.map(d => d.votes>0?(d.score/d.votes).toFixed(1):0), backgroundColor: '#007AFF', borderRadius: 4 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { y: { beginAtZero: true, max: 5 } } }
                });
            },

            // --- VIEW MGMT ---
            switchView: (v) => {
                state.currentView = v;
                ['home','stats','admin'].forEach(id => {
                    const btn = document.getElementById('nav-'+id);
                    if(btn) id===v ? btn.classList.add('bg-black', 'text-white') : btn.classList.remove('bg-black', 'text-white');
                });
                ['view-home', 'view-stats', 'view-admin'].forEach(el => document.getElementById(el).classList.add('hidden'));
                if(v === 'admin') document.getElementById('view-admin').classList.remove('hidden');
                else document.getElementById('view-'+v).classList.remove('hidden');
                if(v === 'stats') { app.renderAll(); setTimeout(app.updateCharts, 100); }
            },

            filterMeal: (m) => {
                state.currentMeal = m;
                ['breakfast','lunch','dinner'].forEach(id => {
                    const btn = document.getElementById('btn-'+id);
                    id===m ? btn.classList.add('bg-black', 'text-white') : btn.classList.remove('bg-black', 'text-white');
                    id===m ? btn.classList.remove('text-gray-500') : btn.classList.add('text-gray-500');
                });
                app.renderAll();
            },

            openConfig: () => document.getElementById('config-modal').classList.remove('hidden'),
            closeConfig: () => document.getElementById('config-modal').classList.add('hidden'),
            
            setupRealtime: () => {
                if(!supabaseClient) return;
                supabaseClient.channel('db-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'dishes' }, app.fetchData)
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'comments' }, app.fetchData)
                    .subscribe();
            }
        };

        // Bind Events
        document.getElementById('login-form').addEventListener('submit', app.login);
        document.getElementById('add-dish-form').addEventListener('submit', app.addDish);
        document.getElementById('add-template-form').addEventListener('submit', app.addTemplateDish);
        document.getElementById('config-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('input-supabase-url').value.trim();
            const k = document.getElementById('input-supabase-key').value.trim();
            if(u && k) { localStorage.setItem('sb_url', u); localStorage.setItem('sb_key', k); location.reload(); }
        });

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>

